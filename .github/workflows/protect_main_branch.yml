name: Protect Main Branch

on:
  push:
    branches:
      - main

jobs:
  prevent-direct-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Check if push is from a pull request merge
        run: |
          # Check if this is a merge commit (has multiple parents)
          PARENT_COUNT=$(git rev-list --parents -n 1 HEAD | wc -w)
          PARENT_COUNT=$((PARENT_COUNT - 1))
          
          # Check if the actor is the GitHub Actions bot or if it's a merge commit
          if [ "$PARENT_COUNT" -lt 2 ] && [ "${{ github.actor }}" != "github-actions[bot]" ]; then
            echo "❌ ERROR: Direct pushes to main branch are not allowed!"
            echo "All changes to main must go through a pull request."
            echo ""
            echo "To fix this:"
            echo "1. Create a new branch: git checkout -b feature/your-feature"
            echo "2. Push your branch: git push origin feature/your-feature"
            echo "3. Create a pull request on GitHub"
            echo ""
            echo "For repository administrators: Configure branch protection rules in Settings → Branches"
            exit 1
          fi
          
          echo "✅ Push appears to be from a pull request merge or automated process"
