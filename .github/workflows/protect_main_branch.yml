name: Protect Main Branch

on:
  push:
    branches:
      - main

jobs:
  prevent-direct-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check if push is from a pull request merge
        run: |
          # Check if this is a merge commit (has multiple parents)
          PARENT_COUNT=$(git rev-list --count HEAD^@ 2>/dev/null || echo "0")
          
          # Check commit message for merge patterns
          COMMIT_MSG=$(git log -1 --pretty=%B HEAD)
          FIRST_LINE=$(echo "$COMMIT_MSG" | head -n 1)
          IS_MERGE_MSG=$(echo "$COMMIT_MSG" | grep -iE '^Merge pull request|^Merge branch' || echo "")
          IS_SQUASH_MERGE=$(echo "$FIRST_LINE" | grep -E '\(#[0-9]+\)$' || echo "")
          
          # Allow if it's a merge commit or if commit message indicates a merge/squash merge
          if [ "$PARENT_COUNT" -ge 2 ] || [ -n "$IS_MERGE_MSG" ] || [ -n "$IS_SQUASH_MERGE" ]; then
            echo "✅ Push appears to be from a pull request merge"
            exit 0
          fi
          
          # Check if the actor is a known bot or service account
          ACTOR="${{ github.actor }}"
          if [[ "$ACTOR" == *"[bot]"* ]] || [[ "$ACTOR" == *"-bot" ]] || [[ "$ACTOR" == *"_bot" ]] || \
             [[ "$ACTOR" == "github-actions"* ]] || [[ "$ACTOR" == "dependabot"* ]] || [[ "$ACTOR" == "renovate"* ]]; then
            echo "✅ Push is from an automated service account: $ACTOR"
            exit 0
          fi
          
          # If we reach here, it's likely a direct push
          echo "❌ ERROR: Direct pushes to main branch are not allowed!"
          echo "All changes to main must go through a pull request."
          echo ""
          echo "To fix this:"
          echo "1. Create a new branch: git checkout -b feature/your-feature"
          echo "2. Push your branch: git push origin feature/your-feature"
          echo "3. Create a pull request on GitHub"
          echo ""
          echo "For repository administrators: Configure branch protection rules in Settings → Branches"
          exit 1
