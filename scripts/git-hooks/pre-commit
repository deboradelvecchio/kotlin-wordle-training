#!/bin/sh
#
# Pre-commit hook to run formatting (Spotless for backend, Prettier for frontend)
#

# Get list of staged files (only Added, Copied, Modified - not Deleted)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# Check if there are backend changes (Kotlin files)
BACKEND_CHANGES=$(echo "$STAGED_FILES" | grep -E '\.(kt|java)$' || true)

# Check if there are frontend changes (TypeScript/React files)
FRONTEND_CHANGES=$(echo "$STAGED_FILES" | grep -E 'frontend/.*\.(ts|tsx|js|jsx|json|css)$' || true)

# Run Spotless if there are backend changes
if [ -n "$BACKEND_CHANGES" ]; then
    echo "Running Spotless formatting for backend..."
    ./mvnw spotless:apply
fi

# Run Prettier if there are frontend changes
if [ -n "$FRONTEND_CHANGES" ]; then
    echo "Running Prettier formatting for frontend..."
    cd frontend && npm run format && cd ..
fi

# Re-stage ONLY the files that were originally staged (not all changes)
if [ -n "$STAGED_FILES" ]; then
    echo "Re-staging formatted files..."
    echo "$STAGED_FILES" | xargs git add
fi

echo "âœ… Code is properly formatted!"
exit 0
